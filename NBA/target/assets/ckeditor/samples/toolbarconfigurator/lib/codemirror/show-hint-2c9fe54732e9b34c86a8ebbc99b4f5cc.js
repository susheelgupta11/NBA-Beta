(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)})(function(e){function t(e,t){this.cm=e;this.options=this.buildOptions(t);this.widget=null;this.tick=this.debounce=0;this.startPos=this.cm.getCursor();this.startLen=this.cm.getLine(this.startPos.line).length;var n=this;e.on("cursorActivity",this.activityFunc=function(){n.cursorActivity()})}function n(e,t){function n(e,n){var i;i="string"!=typeof n?function(e){return n(e,t)}:r.hasOwnProperty(n)?r[n]:n;s[e]=i}var r={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize()+1,!0)},PageDown:function(){t.moveFocus(t.menuSize()-1,!0)},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length-1)},Enter:t.pick,Tab:t.pick,Esc:t.close},i=e.options.customKeys,s=i?{}:r;if(i)for(var o in i)i.hasOwnProperty(o)&&n(o,i[o]);if(i=e.options.extraKeys)for(o in i)i.hasOwnProperty(o)&&n(o,i[o]);return s}function r(e,t){for(;t&&t!=e;){if("LI"===t.nodeName.toUpperCase()&&t.parentNode==e)return t;t=t.parentNode}}function i(t,i){this.completion=t;this.data=i;this.picked=!1;var s=this,o=t.cm,u=this.hints=document.createElement("ul");u.className="CodeMirror-hints";this.selectedHint=i.selectedHint||0;for(var a=i.list,l=0;l<a.length;++l){var c=u.appendChild(document.createElement("li")),h=a[l],p="CodeMirror-hint"+(l!=this.selectedHint?"":" CodeMirror-hint-active");null!=h.className&&(p=h.className+" "+p);c.className=p;h.render?h.render(c,i,h):c.appendChild(document.createTextNode(h.displayText||("string"==typeof h?h:h.text)));c.hintId=l}var l=o.cursorCoords(t.options.alignWithWord?i.from:null),d=l.left,m=l.bottom,g=!0;u.style.left=d+"px";u.style.top=m+"px";c=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);p=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(t.options.container||document.body).appendChild(u);h=u.getBoundingClientRect();if(0<h.bottom-p){var y=h.bottom-h.top;0<l.top-(l.bottom-h.top)-y?(u.style.top=(m=l.top-y)+"px",g=!1):y>p&&(u.style.height=p-5+"px",u.style.top=(m=l.bottom-h.top)+"px",p=o.getCursor(),i.from.ch!=p.ch&&(l=o.cursorCoords(p),u.style.left=(d=l.left)+"px",h=u.getBoundingClientRect()))}p=h.right-c;0<p&&(h.right-h.left>c&&(u.style.width=c-5+"px",p-=h.right-h.left-c),u.style.left=(d=l.left-p)+"px");o.addKeyMap(this.keyMap=n(t,{moveFocus:function(e,t){s.changeActive(s.selectedHint+e,t)},setFocus:function(e){s.changeActive(e)},menuSize:function(){return s.screenAmount()},length:a.length,close:function(){t.close()},pick:function(){s.pick()},data:i}));if(t.options.closeOnUnfocus){var b;o.on("blur",this.onBlur=function(){b=setTimeout(function(){t.close()},100)});o.on("focus",this.onFocus=function(){clearTimeout(b)})}var E=o.getScrollInfo();o.on("scroll",this.onScroll=function(){var e=o.getScrollInfo(),n=o.getWrapperElement().getBoundingClientRect(),r=m+E.top-e.top,i=r-(window.pageYOffset||(document.documentElement||document.body).scrollTop);g||(i+=u.offsetHeight);if(i<=n.top||i>=n.bottom)return t.close();u.style.top=r+"px";u.style.left=d+E.left-e.left+"px"});e.on(u,"dblclick",function(e){(e=r(u,e.target||e.srcElement))&&null!=e.hintId&&(s.changeActive(e.hintId),s.pick())});e.on(u,"click",function(e){(e=r(u,e.target||e.srcElement))&&null!=e.hintId&&(s.changeActive(e.hintId),t.options.completeOnSingleClick&&s.pick())});e.on(u,"mousedown",function(){setTimeout(function(){o.focus()},20)});e.signal(i,"select",a[0],u.firstChild);return!0}e.showHint=function(e,t,n){if(!t)return e.showHint(n);n&&n.async&&(t.async=!0);t={hint:t};if(n)for(var r in n)t[r]=n[r];return e.showHint(t)};e.defineExtension("showHint",function(n){1<this.listSelections().length||this.somethingSelected()||(this.state.completionActive&&this.state.completionActive.close(),n=this.state.completionActive=new t(this,n),n.options.hint&&(e.signal(this,"startCompletion",this),n.update()))});var s=window.requestAnimationFrame||function(e){return setTimeout(e,1e3/60)},o=window.cancelAnimationFrame||clearTimeout;t.prototype={close:function(){this.active()&&(this.tick=this.cm.state.completionActive=null,this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.widget.close(),e.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(t,n){var r=t.list[n];r.hint?r.hint(this.cm,t,r):this.cm.replaceRange("string"==typeof r?r:r.text,r.from||t.from,r.to||t.to,"complete");e.signal(t,"pick",r);this.close()},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.options.completeSingle&&1==e.list.length?this.pick(e,0):this.showWidget(e)},cursorActivity:function(){this.debounce&&(o(this.debounce),this.debounce=0);var e=this.cm.getCursor(),t=this.cm.getLine(e.line);if(e.line!=this.startPos.line||t.length-e.ch!=this.startLen-this.startPos.ch||e.ch<this.startPos.ch||this.cm.somethingSelected()||e.ch&&this.options.closeCharacters.test(t.charAt(e.ch-1)))this.close();else{var n=this;this.debounce=s(function(){n.update()});this.widget&&this.widget.disable()}},update:function(){if(null!=this.tick)if(this.data&&e.signal(this.data,"update"),this.options.hint.async){var t=++this.tick,n=this;this.options.hint(this.cm,function(e){n.tick==t&&n.finishUpdate(e)},this.options)}else this.finishUpdate(this.options.hint(this.cm,this.options),t)},finishUpdate:function(e){this.data=e;var t=this.widget&&this.widget.picked;this.widget&&this.widget.close();e&&e.list.length&&(t&&1==e.list.length?this.pick(e,0):this.widget=new i(this,e))},showWidget:function(t){this.data=t;this.widget=new i(this,t);e.signal(t,"shown")},buildOptions:function(e){var t=this.cm.options.hintOptions,n={},r;for(r in u)n[r]=u[r];if(t)for(r in t)void 0!==t[r]&&(n[r]=t[r]);if(e)for(r in e)void 0!==e[r]&&(n[r]=e[r]);return n}};i.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus));e.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var e=this;this.keyMap={Enter:function(){e.picked=!0}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(t,n){t>=this.data.list.length?t=n?this.data.list.length-1:0:0>t&&(t=n?0:this.data.list.length-1);if(this.selectedHint!=t){var r=this.hints.childNodes[this.selectedHint];r.className=r.className.replace(" CodeMirror-hint-active","");r=this.hints.childNodes[this.selectedHint=t];r.className+=" CodeMirror-hint-active";r.offsetTop<this.hints.scrollTop?this.hints.scrollTop=r.offsetTop-3:r.offsetTop+r.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=r.offsetTop+r.offsetHeight-this.hints.clientHeight+3);e.signal(this.data,"select",this.data.list[this.selectedHint],r)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};e.registerHelper("hint","auto",function(t,n){var r=t.getHelpers(t.getCursor(),"hint");if(r.length)for(var i=0;i<r.length;i++){var s=r[i](t,n);if(s&&s.list.length)return s}else if(r=t.getHelper(t.getCursor(),"hintWords")){if(r)return e.hint.fromList(t,{words:r})}else if(e.hint.anyword)return e.hint.anyword(t,n)});e.registerHelper("hint","fromList",function(t,n){for(var r=t.getCursor(),i=t.getTokenAt(r),s=[],o=0;o<n.words.length;o++){var u=n.words[o];u.slice(0,i.string.length)==i.string&&s.push(u)}if(s.length)return{list:s,from:e.Pos(r.line,i.start),to:e.Pos(r.line,i.end)}});e.commands.autocomplete=e.showHint;var u={hint:e.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:!0,completeOnSingleClick:!1,container:null,customKeys:null,extraKeys:null};e.defineOption("hintOptions",null)})