(function(){function d(e,t){l.call(this,e,t);this.actualConfig=this.originalConfig=this.removedButtons=null;this.emptyVisible=!1;this.state="edit";this.toolbarButtons=[{text:{active:"Hide empty toolbar groups",inactive:"Show empty toolbar groups"},group:"edit",position:"left",cssClass:"button-a-soft",clickCallback:function(e,t){e[e.hasClass("button-a-background")?"removeClass":"addClass"]("button-a-background");this._toggleVisibilityEmptyElements();this.emptyVisible?e.setText(t.text.active):e.setText(t.text.inactive)}},{text:"Add row separator",group:"edit",position:"left",cssClass:"button-a-soft",clickCallback:function(){this._addSeparator()}},{text:"Select config",group:"config",position:"left",cssClass:"button-a-soft",clickCallback:function(){this.configContainer.findOne("textarea").$.select()}},{text:"Back to configurator",group:"config",position:"right",cssClass:"button-a-background",clickCallback:function(){if("paste"===this.state){var e=this.configContainer.findOne("textarea").getValue();(e=d.evaluateToolbarGroupsConfig(e))?this.setConfig(e):alert("Your pasted config is wrong.")}this.state="edit";this._showConfigurationTool();this.showToolbarBtnsByGroupName(this.state)}},{text:'Get toolbar <span class="highlight">config</span>',group:"edit",position:"right",cssClass:"button-a-background icon-pos-left icon-download",clickCallback:function(){this.state="config";this._showConfig();this.showToolbarBtnsByGroupName(this.state)}}];this.cachedActiveElement=null}var l=ToolbarConfigurator.AbstractToolbarModifier;ToolbarConfigurator.ToolbarModifier=d;d.prototype=Object.create(ToolbarConfigurator.AbstractToolbarModifier.prototype);d.prototype.getActualConfig=function(){var e=l.prototype.getActualConfig.call(this);if(e.toolbarGroups)for(var t=e.toolbarGroups.length,n=0;n<t;n+=1)e.toolbarGroups[n]=d.parseGroupToConfigValue(e.toolbarGroups[n]);return e};d.prototype._onInit=function(e,t,n){n=!0===n;l.prototype._onInit.call(this,void 0,t);this.removedButtons=[];n?this.removedButtons=this.actualConfig.removeButtons?this.actualConfig.removeButtons.split(","):[]:"removeButtons"in this.originalConfig?this.removedButtons=this.originalConfig.removeButtons?this.originalConfig.removeButtons.split(","):[]:(this.originalConfig.removeButtons="",this.removedButtons=[]);this.actualConfig.toolbarGroups||(this.actualConfig.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig());this._fixGroups(this.actualConfig);this._calculateTotalBtns();this._createModifier();this._refreshMoveBtnsAvalibility();this._refreshBtnTabIndexes();"function"===typeof e&&e(this.mainContainer)};d.prototype._showConfigurationTool=function(){this.configContainer.addClass("hidden");this.modifyContainer.removeClass("hidden")};d.prototype._showConfig=function(){var e=this.getActualConfig(),t,n;if(e.toolbarGroups){t=e.toolbarGroups;for(var r=this.cfg.trimEmptyGroups,i=[],s=t.length,o=0;o<s;o++){var u=t[o];if("/"===u)i.push("'/'");else{if(r)for(var a=u.groups.length;a--;)0===d.getTotalSubGroupButtonsNumber(u.groups[a],this.fullToolbarEditor)&&u.groups.splice(a,1);r&&0===u.groups.length||i.push(l.stringifyJSONintoOneLine(u,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0}))}}t="\n		"+i.join(",\n		")}e.removeButtons&&(n=e.removeButtons);e=['<textarea class="configCode" readonly>CKEDITOR.editorConfig = function( config ) {\n',t?"	config.toolbarGroups = ["+t+"\n	];":"",n?"\n\n":"",n?"	config.removeButtons = '"+n+"';":"","\n};</textarea>"].join("");this.modifyContainer.addClass("hidden");this.configContainer.removeClass("hidden");this.configContainer.setHtml(e)};d.prototype._toggleVisibilityEmptyElements=function(){this.modifyContainer.hasClass("empty-visible")?(this.modifyContainer.removeClass("empty-visible"),this.emptyVisible=!1):(this.modifyContainer.addClass("empty-visible"),this.emptyVisible=!0);this._refreshMoveBtnsAvalibility()};d.prototype._createModifier=function(){function e(){t._highlightGroup(this.data("name"))}var t=this;l.prototype._createModifier.call(this);this.modifyContainer.setHtml(this._toolbarConfigToListString());var n=this.modifyContainer.find('li[data-type="group"]');this.modifyContainer.on("mouseleave",function(){this._dehighlightActiveToolGroup()},this);for(var r=n.count(),i=0;i<r;i+=1)n.getItem(i).on("mouseenter",e);CKEDITOR.document.on("keypress",function(e){e=e.data.$.keyCode;e=32===e||13===e;var n=new CKEDITOR.dom.element(CKEDITOR.document.$.activeElement);n.getAscendant(function(e){return e.$===t.mainContainer.$})&&e&&"button"===n.data("type")&&n.findOne("input").$.click()});this.modifyContainer.on("click",function(e){var n=e.data.$,r=new CKEDITOR.dom.element(n.target||n.srcElement);if(e=d.getGroupOrSeparatorLiAncestor(r)){t.cachedActiveElement=document.activeElement;if(r.$ instanceof HTMLInputElement)t._handleCheckboxClicked(r);else if(r.$ instanceof HTMLButtonElement&&(n.preventDefault?n.preventDefault():n.returnValue=!1,(n=t._handleAnchorClicked(r.$))&&"remove"==n.action))return;n=e.data("type");e=e.data("name");t._setActiveElement(n,e);t.cachedActiveElement&&t.cachedActiveElement.focus()}});this.toolbarContainer||(this._createToolbar(),this.toolbarContainer.insertBefore(this.mainContainer.getChildren().getItem(0)));this.showToolbarBtnsByGroupName("edit");this.configContainer||(this.configContainer=new CKEDITOR.dom.element("div"),this.configContainer.addClass("configContainer"),this.configContainer.addClass("hidden"),this.mainContainer.append(this.configContainer));return this.mainContainer};d.prototype.showToolbarBtnsByGroupName=function(e){if(this.toolbarContainer)for(var t=this.toolbarContainer.find("button"),n=t.count(),r=0;r<n;r+=1){var i=t.getItem(r);i.data("group")==e?i.removeClass("hidden"):i.addClass("hidden")}};d.parseGroupToConfigValue=function(e){if("separator"==e.type)return"/";var t=e.groups,n=t.length;delete e.totalBtns;for(var r=0;r<n;r+=1)t[r]=t[r].name;return e};d.getGroupOrSeparatorLiAncestor=function(e){return e.$ instanceof HTMLLIElement&&"group"==e.data("type")?e:d.getFirstAncestor(e,function(e){e=e.data("type");return"group"==e||"separator"==e})};d.prototype._setActiveElement=function(e,t){this.currentActive&&this.currentActive.elem.removeClass("active");if(null===e)this._dehighlightActiveToolGroup(),this.currentActive=null;else{var n=this.mainContainer.findOne('ul[data-type=table-body] li[data-type="'+e+'"][data-name="'+t+'"]');n.addClass("active");this.currentActive={type:e,name:t,elem:n};"group"==e&&this._highlightGroup(t);"separator"==e&&this._dehighlightActiveToolGroup()}};d.prototype.getActiveToolGroup=function(){return this.editorInstance.container?this.editorInstance.container.findOne(".cke_toolgroup.active, .cke_toolbar.active"):null};d.prototype._dehighlightActiveToolGroup=function(){var e=this.getActiveToolGroup();e&&e.removeClass("active");this.editorInstance.container&&this.editorInstance.container.removeClass("some-toolbar-active")};d.prototype._highlightGroup=function(e){this.editorInstance.container&&(e=this.getFirstEnabledButtonInGroup(e),e=this.editorInstance.container.findOne(".cke_button__"+e+", .cke_combo__"+e),this._dehighlightActiveToolGroup(),this.editorInstance.container&&this.editorInstance.container.addClass("some-toolbar-active"),e&&(e=d.getFirstAncestor(e,function(e){return e.hasClass("cke_toolbar")}))&&e.addClass("active"))};d.prototype.getFirstEnabledButtonInGroup=function(e){var t=this.actualConfig.toolbarGroups;e=this.getGroupIndex(e);t=t[e];if(-1===e)return null;e=t.groups?t.groups.length:0;for(var n=0;n<e;n+=1){var r=this.getFirstEnabledButtonInSubgroup(t.groups[n].name);if(r)return r}return null};d.prototype.getFirstEnabledButtonInSubgroup=function(e){for(var t=(e=this.fullToolbarEditor.buttonsByGroup[e])?e.length:0,n=0;n<t;n+=1){var r=e[n].name;if(!this.isButtonRemoved(r))return r}return null};d.prototype._handleCheckboxClicked=function(e){var t=e.getAscendant("li").data("name");e.$.checked?this._removeButtonFromRemoved(t):this._addButtonToRemoved(t)};d.prototype._handleAnchorClicked=function(e){e=new CKEDITOR.dom.element(e);var t=e.getAscendant("li"),n=t.getAscendant("ul"),r=t.data("type"),i=t.data("name"),s=e.data("direction"),o="up"===s?t.getPrevious():t.getNext(),u;if(e.hasClass("disabled"))return null;if(e.hasClass("remove"))return t.remove(),this._removeSeparator(t.data("name")),this._setActiveElement(null),{action:"remove"};if(!e.hasClass("move")||!o)return{action:null};if("group"===r||"separator"===r)u=this._moveGroup(s,i);"subgroup"===r&&(u=t.getAscendant("li").data("name"),u=this._moveSubgroup(s,u,i));"up"===s&&t.insertBefore(n.getChild(u));"down"===s&&t.insertAfter(n.getChild(u));for(var a;t="up"===s?t.getPrevious():t.getNext();)if(this.emptyVisible||!t.hasClass("empty")){a=t;break}a||(a='[data-direction="'+("up"===s?"down":"up")+'"]',this.cachedActiveElement=e.getParent().findOne(a));this._refreshMoveBtnsAvalibility();this._refreshBtnTabIndexes();return{action:"move"}};d.prototype._refreshMoveBtnsAvalibility=function(){function e(e){var n=e.count();for(i=0;i<n;i+=1)t._disableElementsInList(e.getItem(i))}for(var t=this,n=this.mainContainer.find("ul[data-type=table-body] li > p > span > button.move.disabled"),r=n.count(),i=0;i<r;i+=1)n.getItem(i).removeClass("disabled");e(this.mainContainer.find("ul[data-type=table-body]"));e(this.mainContainer.find("ul[data-type=table-body] > li > ul"))};d.prototype._refreshBtnTabIndexes=function(){for(var e=this.mainContainer.find('[data-tab="true"]'),t=e.count(),n=0;n<t;n++){var r=e.getItem(n),i=r.hasClass("disabled");r.setAttribute("tabindex",i?-1:n)}};d.prototype._disableElementsInList=function(e){function t(e){return!e.hasClass("empty")}if(e.getChildren().count()){var n;this.emptyVisible?(n=e.getFirst(),e=e.getLast()):(n=e.getFirst(t),e=e.getLast(t));if(n)var r=n.findOne('p button[data-direction="up"]');if(e)var i=e.findOne('p button[data-direction="down"]');r&&(r.addClass("disabled"),r.setAttribute("tabindex","-1"));i&&(i.addClass("disabled"),i.setAttribute("tabindex","-1"))}};d.prototype.getGroupIndex=function(e){for(var t=this.actualConfig.toolbarGroups,n=t.length,r=0;r<n;r+=1)if(t[r].name===e)return r;return-1};d.prototype._addSeparator=function(){var e=this._determineSeparatorToAddIndex(),t=d.createSeparatorLiteral(),n=CKEDITOR.dom.element.createFromHtml(d.getToolbarSeparatorString(t));this.actualConfig.toolbarGroups.splice(e,0,t);n.insertBefore(this.modifyContainer.findOne("ul[data-type=table-body]").getChild(e));this._setActiveElement("separator",t.name);this._refreshMoveBtnsAvalibility();this._refreshBtnTabIndexes();this._refreshEditor()};d.prototype._removeSeparator=function(e){var t=CKEDITOR.tools.indexOf(this.actualConfig.toolbarGroups,function(t){return"separator"==t.type&&t.name==e});this.actualConfig.toolbarGroups.splice(t,1);this._refreshMoveBtnsAvalibility();this._refreshBtnTabIndexes();this._refreshEditor()};d.prototype._determineSeparatorToAddIndex=function(){return this.currentActive?("group"==this.currentActive.elem.data("type")||"separator"==this.currentActive.elem.data("type")?this.currentActive.elem:this.currentActive.elem.getAscendant("li")).getIndex():0};d.prototype._moveElement=function(e,t,n){function r(e){return e.totalBtns||"separator"==e.type}n=this.emptyVisible?"down"==n?t+1:t-1:d.getFirstElementIndexWith(e,t,n,r);return d.moveTo(n-t,e,t)};d.prototype._moveGroup=function(e,t){var n=this.getGroupIndex(t),n=this._moveElement(this.actualConfig.toolbarGroups,n,e);this._refreshMoveBtnsAvalibility();this._refreshBtnTabIndexes();this._refreshEditor();return n};d.prototype._moveSubgroup=function(e,t,n){t=this.getGroupIndex(t);t=this.actualConfig.toolbarGroups[t];var r=CKEDITOR.tools.indexOf(t.groups,function(e){return e.name==n});e=this._moveElement(t.groups,r,e);this._refreshEditor();return e};d.prototype._calculateTotalBtns=function(){for(var e=this.actualConfig.toolbarGroups,t=e.length;t--;){var n=e[t],r=d.getTotalGroupButtonsNumber(n,this.fullToolbarEditor);"separator"!=n.type&&(n.totalBtns=r)}};d.prototype._addButtonToRemoved=function(e){if(-1!=CKEDITOR.tools.indexOf(this.removedButtons,e))throw"Button already added to removed";this.removedButtons.push(e);this.actualConfig.removeButtons=this.removedButtons.join(",");this._refreshEditor()};d.prototype._removeButtonFromRemoved=function(e){e=CKEDITOR.tools.indexOf(this.removedButtons,e);if(-1===e)throw"Trying to remove button from removed, but not found";this.removedButtons.splice(e,1);this.actualConfig.removeButtons=this.removedButtons.join(",");this._refreshEditor()};d.parseGroupToConfigValue=function(e){if("separator"==e.type)return"/";var t=e.groups,n=t.length;delete e.totalBtns;for(var r=0;r<n;r+=1)t[r]=t[r].name;return e};d.getGroupOrSeparatorLiAncestor=function(e){return e.$ instanceof HTMLLIElement&&"group"==e.data("type")?e:d.getFirstAncestor(e,function(e){e=e.data("type");return"group"==e||"separator"==e})};d.createSeparatorLiteral=function(){return{type:"separator",name:"separator"+CKEDITOR.tools.getNextNumber()}};d.prototype._toolbarConfigToListString=function(){for(var e=this.actualConfig.toolbarGroups||[],t='<ul data-type="table-body">',n=e.length,r=0;r<n;r+=1)var i=e[r],t="separator"===i.type?t+d.getToolbarSeparatorString(i):t+this._getToolbarGroupString(i);t+="</ul>";return d.getToolbarHeaderString()+t};d.prototype._getToolbarGroupString=function(e){var t=e.groups,n;n=""+['<li data-type="group" data-name="',e.name,'" ',e.totalBtns?"":'class="empty"',">"].join("");n+=d.getToolbarElementPreString(e)+"<ul>";e=t.length;for(var r=0;r<e;r+=1){var i=t[r];n+=this._getToolbarSubgroupString(i,this.fullToolbarEditor.buttonsByGroup[i.name])}return n+"</ul></li>"};d.getToolbarSeparatorString=function(e){return['<li data-type="',e.type,'" data-name="',e.name,'">',d.getToolbarElementPreString("row separator"),"</li>"].join("")};d.getToolbarHeaderString=function(){return'<ul data-type="table-header"><li data-type="header"><p>Toolbars</p><ul><li><p>Toolbar groups</p><p>Toolbar group items</p></li></ul></li></ul>'};d.getFirstAncestor=function(e,t){for(var n=e.getParents(),r=n.length;r--;)if(t(n[r]))return n[r];return null};d.getFirstElementIndexWith=function(e,t,n,r){for(;"up"===n?t--:++t<e.length;)if(r(e[t]))return t;return-1};d.moveTo=function(e,t,n){var r;-1!==n&&(r=t.splice(n,1)[0]);e=n+e;t.splice(e,0,r);return e};d.getTotalSubGroupButtonsNumber=function(e,t){var n=t.buttonsByGroup["string"==typeof e?e:e.name];return n?n.length:0};d.getTotalGroupButtonsNumber=function(e,t){for(var n=0,r=e.groups,i=r?r.length:0,s=0;s<i;s+=1)n+=d.getTotalSubGroupButtonsNumber(r[s],t);return n};d.prototype._getToolbarSubgroupString=function(e,t){var n;n=""+['<li data-type="subgroup" data-name="',e.name,'" ',e.totalBtns?"":'class="empty" ',">"].join("");n+=d.getToolbarElementPreString(e.name);n+="<ul>";for(var r=t?t.length:0,i=0;i<r;i+=1)n+=this.getButtonString(t[i]);return n+="</ul></li>"};d.prototype._getConfigButtonName=function(e){var t=this.fullToolbarEditor.editorInstance.ui.items,n;for(n in t)if(t[n].name==e)return n;return null};d.prototype.isButtonRemoved=function(e){return-1!=CKEDITOR.tools.indexOf(this.removedButtons,this._getConfigButtonName(e))};d.prototype.getButtonString=function(e){var t=this.isButtonRemoved(e.name)?"":'checked="checked"';return['<li data-tab="true" data-type="button" data-name="',this._getConfigButtonName(e.name),'"><label title="',e.label,'" ><input tabindex="-1"type="checkbox"',t,"/>",e.$.getOuterHtml(),"</label></li>"].join("")};d.getToolbarElementPreString=function(e){e=e.name?e.name:e;return['<p><span><button title="Move element upward" data-tab="true" data-direction="up" class="move icon-up-big"></button><button title="Move element downward" data-tab="true" data-direction="down" class="move icon-down-big"></button>',"row separator"==e?'<button title="Remove element" data-tab="true" class="remove icon-trash"></button>':"",e,"</span></p>"].join("")};d.evaluateToolbarGroupsConfig=function(a){return a=function(a){var c={},d;try{d=eval("("+a+")")}catch(f){try{d=eval(a)}catch(g){return null}}return c.toolbarGroups&&"number"===typeof c.toolbarGroups.length?JSON.stringify(c):d&&"number"===typeof d.length?JSON.stringify({toolbarGroups:d}):d&&d.toolbarGroups?JSON.stringify(d):null}(a)};return d})()